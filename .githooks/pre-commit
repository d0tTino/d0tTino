#!/bin/sh
set -e
SCRIPT="scripts/export-winget.ps1"
OS=$(uname -s)
case "$OS" in
    CYGWIN*|MINGW*|MSYS*|Windows_NT)
        if command -v pwsh >/dev/null 2>&1; then
            pwsh -NoLogo -NoProfile -File "$SCRIPT"
        elif command -v powershell >/dev/null 2>&1; then
            powershell -NoLogo -NoProfile -ExecutionPolicy Bypass -File "$SCRIPT"
        else
            echo "PowerShell is not installed" >&2
            exit 1
        fi
        git add winget-packages.json
        ;;
    Linux*)
        if command -v winget >/dev/null 2>&1; then
            winget export -o winget-packages.json --accept-source-agreements
            git add winget-packages.json
        else
            echo "Skipping winget export on Linux"
        fi
        ;;
    *)
        echo "Skipping winget export on unsupported OS: $OS"
        ;;
esac

# Validate winget-packages.json after export
python3 scripts/validate_winget.py
